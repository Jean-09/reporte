<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/dashboard-admin" text="Volver"></ion-back-button>
    </ion-buttons>
    <ion-title>Gestión de Usuarios</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="mostrarFormularioNuevo()">
        <ion-icon name="person-add"></ion-icon>
        Nuevo
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Formulario de Usuario -->
  <ion-card *ngIf="mostrandoFormulario">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="person"></ion-icon>
        {{ editandoUsuario ? 'Editar Usuario' : 'Nuevo Usuario' }}
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <form #usuarioForm="ngForm">
        <ion-item>
          <ion-label position="stacked">Nombre Completo *</ion-label>
          <ion-input [(ngModel)]="nuevoUsuario.nombre" name="nombre" placeholder="Ingrese el nombre completo" required>
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Correo Electrónico *</ion-label>
          <ion-input [(ngModel)]="nuevoUsuario.email" name="email" type="email" placeholder="usuario@universidad.edu"
            required>
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Rol *</ion-label>
          <ion-select [(ngModel)]="nuevoUsuario.role" name="rol" placeholder="Seleccione el rol" required>
            <ion-select-option value="Authenticated">usuario</ion-select-option>
            <ion-select-option value="Técnico">Técnico</ion-select-option>
            <ion-select-option value="Administrador">Administrador</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item *ngIf="nuevoUsuario.role !== 'administrador' && nuevoUsuario.role !== 'tecnico'">
          <ion-label position="stacked">Edificio Asignado</ion-label>
          <ion-select [(ngModel)]="nuevoUsuario.edificio" name="edificio" placeholder="Seleccione el edificio">
            <ion-select-option *ngFor="let edificio of edificios" [value]="edificio">
              {{ edificio.nombre }}
            </ion-select-option>
          </ion-select>
        </ion-item>


        <div class="form-buttons">
          <ion-button expand="block" color="primary" (click)="guardarUsuario()" [disabled]="!usuarioForm.form.valid">
            <ion-icon name="save" slot="start"></ion-icon>
            {{ editandoUsuario ? 'Actualizar' : 'Crear' }} Usuario
          </ion-button>

          <ion-button expand="block" fill="outline" color="medium" (click)="cancelarFormulario()">
            <ion-icon name="close" slot="start"></ion-icon>
            Cancelar
          </ion-button>
        </div>
      </form>
    </ion-card-content>
  </ion-card>

  <!-- Filtros -->
  <ion-card>
    <ion-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="12" size-md="6">
            <ion-item>
              <ion-label position="stacked">Filtrar por Rol</ion-label>
              <ion-select [(ngModel)]="filtroRol" (ionChange)="onFiltroChange()">
                <ion-select-option value="todos">Todos los roles</ion-select-option>
                <ion-select-option value="Authenticated">usuario</ion-select-option>
                <ion-select-option value="Técnico">Técnico</ion-select-option>
                <ion-select-option value="Administrador">Administrador</ion-select-option>
              </ion-select>
            </ion-item>
          </ion-col>
          <ion-col size="12" size-md="6">
            <ion-item>
              <ion-label position="stacked">Filtrar por Edificio</ion-label>
              <ion-select [(ngModel)]="filtroEdificio" (ionChange)="onFiltroChange()">
                <ion-select-option value="todos">Todos los edificios</ion-select-option>
                <ion-select-option *ngFor="let edificio of edificios" [value]="edificio.nombre">
                  {{ edificio.nombre }}
                </ion-select-option>
              </ion-select>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <!-- Lista de Usuarios -->
  <div class="usuarios-container">
    <ion-card *ngFor="let usuario of usuariosFiltrados" class="usuario-card">
      <ion-card-content>
        <div class="usuario-header">
          <div class="usuario-info">
            <h3>
              <img
                [src]="usuario.avatar?.url ? 'http://localhost:1337' + usuario.avatar.url : 'assets/img/default-avatar.png'"
                alt="Avatar"
                style="width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; vertical-align: middle;" />
              {{ usuario.nombre }}
            </h3>

            <p>{{ usuario.email }}</p>

          </div>
          <div class="usuario-badges">
            <ion-chip [color]="getRolColor(usuario.role.name)">
              {{ getRolTexto(usuario.role.name) }}
            </ion-chip>
            <ion-chip [color]="usuario.activo ? 'success' : 'danger'">
              {{ usuario.activo ? 'Activo' : 'Inactivo' }}
            </ion-chip>
          </div>
        </div>

        <div class="usuario-actions">
          <ion-button fill="clear" size="small" color="primary" (click)="editarUsuario(usuario)">
            <ion-icon name="create" slot="icon-only"></ion-icon>
          </ion-button>

          <ion-button fill="clear" size="small" [color]="usuario.activo ? 'warning' : 'success'"
            (click)="toggleEstadoUsuario(usuario)">
            <ion-icon [name]="usuario.activo ? 'pause' : 'play'" slot="icon-only"></ion-icon>
          </ion-button>


        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Mensaje cuando no hay usuarios -->
  <ion-card *ngIf="usuariosFiltrados.length === 0">
    <ion-card-content class="ion-text-center">
      <ion-icon name="people-outline" style="font-size: 64px; color: #ccc;"></ion-icon>
      <h3>No hay usuarios</h3>
      <p>No se encontraron usuarios con los filtros seleccionados.</p>
    </ion-card-content>
  </ion-card>

  <!-- Botón flotante -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="mostrarFormularioNuevo()">
      <ion-icon name="person-add"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>